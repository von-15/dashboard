<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Developer Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { padding: 2rem; background-color: #f8f9fa; }
  h2 { color: #6C5B7B; margin-bottom: 1.5rem; }
  .stats { margin-bottom: 1rem; font-size: 1.1rem; }
  table th, table td { vertical-align: middle; }
  .navbar-brand { color: #6C5B7B !important; font-weight: bold; }
  .btn-delete { color: white; background-color: #dc3545; padding: 0.25rem 0.5rem; font-size: 0.9rem; }
</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light mb-4 shadow-sm">
  <div class="container-fluid d-flex align-items-center">
    <a class="navbar-brand" href="#">Hatdug Dashboard</a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      ☰
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item">
          <a class="nav-link active" aria-current="page" href="#">Home</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Orders</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Products</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Settings</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<h2>Hatdug Dashboard</h2>

<div class="stats">
  <strong>Total Orders:</strong> <span id="totalOrders">0</span> &nbsp;|&nbsp;
  <strong>Total Revenue:</strong> ₱<span id="totalRevenue">0</span>
</div>

<div id="ordersTable" class="table-responsive"></div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbyV0sEfwwf1SE5RnuqH2b81SV702F69x5Viz_R5qQdsWYpWiNy8MaAFReMxPt_8y0ep/exec";

  let dashboardOrders = [];
  let deletedOrders = new Set(); // store timestamps of deleted orders

  function fetchOrders() {
    fetch(API_URL)
      .then(res => res.json())
      .then(data => {
        // Filter out deleted orders so they stay deleted on refresh
        dashboardOrders = data.filter(order => {
          const key = order.timestamp || "";
          return !deletedOrders.has(key);
        });
        updateDashboard(dashboardOrders);
      })
      .catch(err => console.error("Error fetching orders:", err));
  }

  function updateDashboard(data) {
    const totalOrders = data.length;
    const totalRevenue = data.reduce((sum, order) => {
      const amount = parseInt((order.Total || "₱0").replace("₱","")) || 0;
      return sum + amount;
    }, 0);

    document.getElementById("totalOrders").innerText = totalOrders;
    document.getElementById("totalRevenue").innerText = totalRevenue;

    if (!totalOrders) {
      document.getElementById("ordersTable").innerHTML = "<p>No orders yet.</p>";
      return;
    }

    let table = `<table class="table table-bordered table-striped table-hover">
                  <thead class="table-dark">
                    <tr>
                      <th>Complete</th>
                      <th>Date/Time</th>
                      <th>Messenger Name</th>
                      <th>PP Description</th>
                      <th>Dorm</th>
                      <th>Others</th>
                      <th>Orders</th>
                      <th>Total</th>
                      <th>Instruction</th>
                      <th>Phone</th>
                      <th>Mode of Payment</th>
                      <th>Delete</th>
                    </tr>
                  </thead>
                  <tbody>`;

    data.forEach((order, index) => {
      const key = order.timestamp || `order-${index}`;
      const completed = localStorage.getItem(key) === "true";

      table += `<tr id="orderRow${index}" style="${completed ? 'background-color:#d4edda; text-decoration:line-through;' : ''}">
                  <td class="text-center">
                    <input type="checkbox" ${completed ? 'checked' : ''} onclick="toggleComplete(${index}, '${key}')">
                  </td>
                  <td>${order.timestamp || ""}</td>
                  <td>${order.messName || ""}</td>
                  <td>${order.ppDesc || ""}</td>
                  <td>${order.Dorm || ""}</td>
                  <td>${order.others || ""}</td>
                  <td>${order.Orders || ""}</td>
                  <td>${order.Total || "₱0"}</td>
                  <td>${order.instruction || ""}</td>
                  <td>${order.Phone || ""}</td>
                  <td>${order.Payment || ""}</td>
                  <td class="text-center">
                    <button class="btn btn-delete" onclick="deleteOrder(${index})">Delete</button>
                  </td>
                </tr>`;
    });

    table += "</tbody></table>";
    document.getElementById("ordersTable").innerHTML = table;
  }

  function toggleComplete(index, key) {
    const row = document.getElementById(`orderRow${index}`);
    const checkbox = row.querySelector("input[type='checkbox']");
    if (checkbox.checked) {
      row.style.backgroundColor = "#d4edda";
      row.style.textDecoration = "line-through";
      localStorage.setItem(key, "true");
    } else {
      row.style.backgroundColor = "";
      row.style.textDecoration = "none";
      localStorage.setItem(key, "false");
    }
  }

  function deleteOrder(index) {
    if (confirm("Are you sure you want to delete this order from the dashboard?")) {
      const key = dashboardOrders[index].timestamp || "";
      localStorage.removeItem(key);
      deletedOrders.add(key); // mark as deleted permanently for dashboard
      dashboardOrders.splice(index, 1);
      updateDashboard(dashboardOrders);
    }
  }

  fetchOrders();
  setInterval(fetchOrders, 5000);
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
